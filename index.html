<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cheetah & Lion Object Detection ğŸ†ğŸ¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff9c4; /* à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡à¸­à¹ˆà¸­à¸™ */
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #f39c12; /* à¸ªà¸µà¸—à¸­à¸‡ */
    }
    h2 {
      color: #e67e22;  /* à¸ªà¸µà¸ªà¹‰à¸¡ */
    }
    button {
      background-color: #f39c12; /* à¸ªà¸µà¸—à¸­à¸‡ */
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1.1em;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background-color: #e67e22; /* à¸ªà¸µà¸ªà¹‰à¸¡ */
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      background-color: #ecf0f1;
      font-size: 1em;
      color: #34495e;
      border-radius: 5px;
    }
    #webcam-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Cheetah & Lion Object Detection ğŸ†ğŸ¦</h1>
  <h2>Real-Time Cheetah and Lion Detection ğŸŒğŸ¦“</h2>
  
  <button onclick="init('environment')">Start ğŸ†ğŸ¦ (Back Camera)</button>
  <button onclick="init('user')">Start ğŸ¦ğŸ† (Front Camera)</button>
  <button onclick="stop()">Stop ğŸ›‘</button>

  <div id="status">à¸à¸³à¸¥à¸±à¸‡à¹€à¸•à¸£à¸µà¸¢à¸¡à¸à¸£à¹‰à¸­à¸¡...</div>
  <div id="webcam-container"></div>

  <script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/CennzuTZgr/";
    const MQTT_TOPIC = "JEFFYSOBIG";

    let model, webcam, labelContainer, maxPredictions;
    let mqttClient;
    let sending = false;
    let paused = false;
    let timeoutId;
    let isRunning = false;

    function updateStatus(message, type = "status") {
      const statusDiv = document.getElementById("status");
      statusDiv.innerText = message;
      statusDiv.className = `status ${type}`;
    }

    function connectMQTT() {
      return new Promise((resolve, reject) => {
        try {
          const clientId = "clientId-oHKE0fJ17E" + Math.floor(Math.random() * 10000);
          mqttClient = new Paho.MQTT.Client("broker.hivemq.com", 8884, "/mqtt", clientId);

          mqttClient.onConnectionLost = (responseObject) => {
            console.error("MQTT lost:", responseObject.errorMessage);
            updateStatus("MQTT lost. Reconnecting...", "error");
            if (isRunning) {
              setTimeout(() => connectMQTT().catch(() => {}), 5000);
            }
          };

          mqttClient.connect({
            useSSL: true,
            timeout: 30,
            keepAliveInterval: 60,
            cleanSession: true,
            onSuccess: () => {
              console.log("MQTT connected");
              updateStatus("MQTT à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "success");
              resolve();
            },
            onFailure: (e) => {
              console.error("MQTT failed:", e.errorMessage);
              updateStatus("MQTT à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: " + e.errorMessage, "error");
              reject(e);
            }
          });
        } catch (error) {
          console.error("MQTT setup error:", error);
          updateStatus("MQTT setup error: " + (error?.message || JSON.stringify(error)), "error");
          reject(error);
        }
      });
    }

    async function init(facingMode) {
      try {
        isRunning = true;
        updateStatus("à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MQTT...");
        await connectMQTT();

        updateStatus("à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥...");
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        updateStatus("à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "success");

        updateStatus("à¸à¸³à¸¥à¸±à¸‡à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡...");
        webcam = new tmImage.Webcam(320, 240, false);
        await webcam.setup({ facingMode: facingMode || "environment" });
        await webcam.play();
        
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        updateStatus("à¸à¸¥à¹‰à¸­à¸‡à¹€à¸›à¸´à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ - à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š...", "success");

        window.requestAnimationFrame(loop);

      } catch (error) {
        console.error("Init error:", error);
        updateStatus("Error: " + (error?.message || JSON.stringify(error)), "error");
        isRunning = false;
      }
    }

    async function loop() {
      if (!paused && isRunning && webcam) {
        try {
          webcam.update();
          await predict();
        } catch (error) {
          updateStatus("Prediction error: " + (error?.message || JSON.stringify(error)), "error");
        }
      }
      if (isRunning) {
        setTimeout(() => window.requestAnimationFrame(loop), 100);
      }
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);

      for (let i = 0; i < maxPredictions; i++) {
        const prob = prediction[i].probability;
        const className = prediction[i].className;
        if (prob >= 0.9 && !sending) {
          sending = true;
          paused = true;
          updateStatus(`à¸à¸š ${className} ğŸ¦ğŸ†`);

          if (mqttClient && mqttClient.isConnected()) {
            const message = new Paho.MQTT.Message(className);
            message.destinationName = MQTT_TOPIC;
            mqttClient.send(message);
            updateStatus(`à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§: ${className}`, "success");
          } else {
            updateStatus("MQTT à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­", "error");
          }

          setTimeout(() => {
            sending = false;
            paused = false;
            updateStatus("à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š...", "success");
          }, 1000);
          break;
        }
      }
    }

    function stop() {
      isRunning = false;
      paused = true;
      updateStatus("à¸«à¸¢à¸¸à¸”à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š", "error");
      if (webcam) {
        webcam.stop();
      }
      mqttClient.disconnect();
    }
  </script>
</body>
</html>
